(function(){window.HydrousWidget={};const DEFAULT_CONFIG={apiUrl:"http://localhost:8000/api",primaryColor:"#0891b2",secondaryColor:"#e0f2fe",position:"right",title:"Asistente Técnico",subtitle:"Consultas sobre reciclaje de agua"};window.HydrousWidget.init=function(customConfig={}){const config={...DEFAULT_CONFIG,...customConfig};if(document.getElementById("hydrous-chatbot-container")){console.warn("Hydrous Widget ya está inicializado");return}const container=document.createElement("div");container.id="hydrous-chatbot-container";document.body.appendChild(container);loadStyles(config);const state={isOpen:false,messages:[],conversationId:null,isTyping:false};createChatInterface(container,config,state)};function loadStyles(config){const style=document.createElement("style");style.textContent=`\n      #hydrous-chatbot-container {\n        position: fixed;\n        z-index: 9999;\n        ${config.position==="right"?"right: 20px;":"left: 20px;"}\n        bottom: 20px;\n        font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;\n      }\n      \n      .hydrous-chat-button {\n        width: 64px;\n        height: 64px;\n        border-radius: 50%;\n        background-color: ${config.primaryColor};\n        color: white;\n        border: none;\n        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: all 0.2s ease;\n      }\n      \n      .hydrous-chat-button:hover {\n        transform: scale(1.05);\n      }\n      \n      .hydrous-chat-window {\n        width: 380px;\n        height: 600px;\n        border-radius: 16px;\n        overflow: hidden;\n        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);\n        background-color: white;\n        border: 1px solid rgba(0, 0, 0, 0.1);\n        animation: hydrous-slideUp 0.3s ease;\n        display: flex;\n        flex-direction: column;\n      }\n      \n      .hydrous-chat-header {\n        padding: 18px 20px;\n        background-color: ${config.primaryColor};\n        color: white;\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);\n      }\n      \n      .hydrous-header-title {\n        display: flex;\n        align-items: center;\n        gap: 14px;\n      }\n      \n      .hydrous-avatar {\n        width: 40px;\n        height: 40px;\n        border-radius: 50%;\n        background-color: rgba(255, 255, 255, 0.2);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n      }\n      \n      .hydrous-title-text {\n        font-weight: 600;\n        font-size: 17px;\n        margin-bottom: 2px;\n      }\n      \n      .hydrous-subtitle-text {\n        font-size: 13px;\n        opacity: 0.9;\n      }\n      \n      .hydrous-header-actions {\n        display: flex;\n        gap: 10px;\n      }\n      \n      .hydrous-btn {\n        background-color: rgba(255, 255, 255, 0.1);\n        border: none;\n        color: white;\n        cursor: pointer;\n        width: 34px;\n        height: 34px;\n        border-radius: 50%;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: background-color 0.2s, transform 0.2s;\n      }\n      \n      .hydrous-btn:hover {\n        background-color: rgba(255, 255, 255, 0.2);\n        transform: scale(1.05);\n      }\n      \n      .hydrous-messages-container {\n        flex: 1;\n        padding: 20px;\n        overflow-y: auto;\n        background-color: #f8fafc;\n        background-image: radial-gradient(circle at center, rgba(8, 145, 178, 0.03) 0%, rgba(8, 145, 178, 0) 70%);\n        display: flex;\n        flex-direction: column;\n        gap: 16px;\n      }\n      \n      .hydrous-message {\n        display: flex;\n        flex-direction: column;\n        max-width: 85%;\n        animation: hydrous-fadeIn 0.3s ease;\n      }\n      \n      .hydrous-message-user {\n        align-self: flex-end;\n      }\n      \n      .hydrous-message-bot {\n        align-self: flex-start;\n      }\n      \n      .hydrous-message-bubble {\n        padding: 12px 16px;\n        border-radius: 16px;\n        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);\n        font-size: 14.5px;\n        line-height: 1.6;\n      }\n      \n      .hydrous-message-user .hydrous-message-bubble {\n        background-color: ${config.primaryColor};\n        color: white;\n        border-radius: 16px 4px 16px 16px;\n      }\n      \n      .hydrous-message-bot .hydrous-message-bubble {\n        background-color: ${config.secondaryColor};\n        color: #1e293b;\n        border-radius: 4px 16px 16px 16px;\n        border: 1px solid ${config.secondaryColor};\n      }\n      \n      .hydrous-message-time {\n        font-size: 11px;\n        color: #94a3b8;\n        margin-top: 6px;\n        padding: 0 4px;\n        display: flex;\n        align-items: center;\n        gap: 4px;\n      }\n      \n      .hydrous-bot-indicator {\n        display: inline-block;\n        width: 6px;\n        height: 6px;\n        border-radius: 50%;\n        background-color: ${config.primaryColor};\n        opacity: 0.4;\n      }\n      \n      .hydrous-typing {\n        display: flex;\n        align-self: flex-start;\n        background-color: ${config.secondaryColor};\n        padding: 10px 16px;\n        border-radius: 4px 16px 16px 16px;\n        max-width: 85%;\n        box-shadow: 0 2px 8px rgba(8, 145, 178, 0.08);\n        border: 1px solid ${config.secondaryColor};\n      }\n      \n      .hydrous-typing-dots {\n        display: flex;\n        align-items: center;\n        gap: 4px;\n      }\n      \n      .hydrous-dot {\n        width: 8px;\n        height: 8px;\n        border-radius: 50%;\n        background-color: ${config.primaryColor};\n        animation: hydrous-pulse 1.2s infinite ease-in-out;\n      }\n      \n      .hydrous-dot:nth-child(2) {\n        animation-delay: 0.2s;\n      }\n      \n      .hydrous-dot:nth-child(3) {\n        animation-delay: 0.4s;\n      }\n      \n      .hydrous-typing-text {\n        position: absolute;\n        bottom: -18px;\n        left: 10px;\n        font-size: 10px;\n        color: #94a3b8;\n      }\n      \n      .hydrous-input-container {\n        padding: 16px 20px;\n        border-top: 1px solid #e2e8f0;\n        background-color: white;\n        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);\n      }\n      \n      .hydrous-input-wrapper {\n        display: flex;\n        align-items: flex-end;\n        gap: 10px;\n        position: relative;\n      }\n      \n      .hydrous-textarea-container {\n        flex: 1;\n        position: relative;\n        border-radius: 12px;\n        overflow: hidden;\n        box-shadow: 0 2px 4px rgba(0,0,0,0.05);\n        transition: box-shadow 0.2s ease;\n      }\n      \n      .hydrous-textarea {\n        width: 100%;\n        padding: 14px 16px;\n        border: 1px solid #e2e8f0;\n        border-radius: 12px;\n        font-size: 15px;\n        resize: none;\n        min-height: 50px;\n        max-height: 120px;\n        outline: none;\n        line-height: 1.5;\n        transition: border-color 0.2s ease;\n        font-family: inherit;\n      }\n      \n      .hydrous-textarea:focus {\n        border-color: ${config.primaryColor};\n        box-shadow: 0 0 0 2px ${config.primaryColor}20, 0 2px 4px rgba(0,0,0,0.05);\n      }\n      \n      .hydrous-textarea:disabled {\n        background-color: #f8fafc;\n        cursor: not-allowed;\n      }\n      \n      .hydrous-send-btn {\n        width: 44px;\n        height: 44px;\n        border-radius: 50%;\n        background-color: #e2e8f0;\n        color: white;\n        border: none;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: not-allowed;\n        transition: all 0.2s ease;\n        flex-shrink: 0;\n      }\n      \n      .hydrous-send-btn.active {\n        background-color: ${config.primaryColor};\n        cursor: pointer;\n        box-shadow: 0 4px 10px rgba(8, 145, 178, 0.2);\n      }\n      \n      .hydrous-send-btn.active:hover {\n        transform: translateY(-2px);\n        box-shadow: 0 6px 12px rgba(8, 145, 178, 0.25);\n      }\n      \n      .hydrous-input-info {\n        margin-top: 10px;\n        font-size: 11px;\n        color: #94a3b8;\n        text-align: center;\n      }\n      \n      .hydrous-empty-state {\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        height: 100%;\n        color: #64748b;\n        text-align: center;\n        padding: 20px;\n      }\n      \n      .hydrous-empty-icon {\n        width: 80px;\n        height: 80px;\n        border-radius: 50%;\n        background-color: #e0f2fe;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        margin-bottom: 20px;\n        box-shadow: 0 6px 16px rgba(8, 145, 178, 0.1);\n      }\n      \n      .hydrous-empty-title {\n        font-size: 16px;\n        font-weight: 600;\n        margin-bottom: 12px;\n        color: #334155;\n      }\n      \n      .hydrous-empty-text {\n        font-size: 14px;\n        max-width: 280px;\n        line-height: 1.6;\n        color: #64748b;\n      }\n      \n      @keyframes hydrous-fadeIn {\n        from {\n          opacity: 0;\n          transform: translateY(5px);\n        }\n        to {\n          opacity: 1;\n          transform: translateY(0);\n        }\n      }\n      \n      @keyframes hydrous-slideUp {\n        from {\n          opacity: 0;\n          transform: translateY(10px);\n        }\n        to {\n          opacity: 1;\n          transform: translateY(0);\n        }\n      }\n      \n      @keyframes hydrous-pulse {\n        0%, 100% {\n          transform: scale(0.8);\n          opacity: 0.6;\n        }\n        50% {\n          transform: scale(1.2);\n          opacity: 1;\n        }\n      }\n      \n      @media (max-width: 480px) {\n        .hydrous-chat-window {\n          width: 100vw;\n          height: 100vh;\n          border-radius: 0;\n          position: fixed;\n          top: 0;\n          left: 0;\n          right: 0;\n          bottom: 0;\n          z-index: 10000;\n        }\n      }\n    `;document.head.appendChild(style)}function createChatInterface(container,config,state){const chatButton=document.createElement("button");chatButton.className="hydrous-chat-button";chatButton.setAttribute("aria-label","Abrir chat");chatButton.innerHTML=`\n      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n        <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z" stroke="white" stroke-width="2"></path>\n      </svg>\n    `;container.appendChild(chatButton);const chatWindow=document.createElement("div");chatWindow.className="hydrous-chat-window";chatWindow.style.display="none";const header=createHeader(config,state);chatWindow.appendChild(header);const messagesContainer=document.createElement("div");messagesContainer.className="hydrous-messages-container";messagesContainer.innerHTML=`\n      <div class="hydrous-empty-state">\n        <div class="hydrous-empty-icon">\n          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z" stroke="${config.primaryColor}" stroke-width="2"></path>\n          </svg>\n        </div>\n        <h3 class="hydrous-empty-title">Asistente de Reciclaje de Agua</h3>\n        <p class="hydrous-empty-text">\n          Inicie una consulta sobre nuestras soluciones tecnológicas para el tratamiento y reciclaje de agua.\n        </p>\n      </div>\n    `;chatWindow.appendChild(messagesContainer);const inputContainer=document.createElement("div");inputContainer.className="hydrous-input-container";inputContainer.innerHTML=`\n      <div class="hydrous-input-wrapper">\n        <div class="hydrous-textarea-container">\n          <textarea \n            class="hydrous-textarea" \n            placeholder="Escriba su consulta técnica..." \n            rows="1"\n          ></textarea>\n        </div>\n        <button class="hydrous-send-btn" disabled>\n          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <line x1="22" y1="2" x2="11" y2="13" stroke="currentColor" stroke-width="2"></line>\n            <polygon points="22 2 15 22 11 13 2 9 22 2" stroke="currentColor" stroke-width="2"></polygon>\n          </svg>\n        </button>\n      </div>\n      <div class="hydrous-input-info">\n        Presione Enter para enviar, Shift+Enter para nueva línea\n      </div>\n    `;chatWindow.appendChild(inputContainer);container.appendChild(chatWindow);setupEvents(chatButton,chatWindow,messagesContainer,inputContainer,config,state)}function createHeader(config,state){const header=document.createElement("div");header.className="hydrous-chat-header";header.innerHTML=`\n      <div class="hydrous-header-title">\n        <div class="hydrous-avatar">\n          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z" stroke="white" stroke-width="2"></path>\n          </svg>\n        </div>\n        <div>\n          <div class="hydrous-title-text">${config.title}</div>\n          <div class="hydrous-subtitle-text">${config.subtitle}</div>\n        </div>\n      </div>\n      <div class="hydrous-header-actions">\n        <button class="hydrous-btn hydrous-reset-btn" title="Reiniciar conversación">\n          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <path d="M1 4V10H7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>\n            <path d="M23 20V14H17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>\n            <path d="M20.49 9C19.9828 7.56678 19.1209 6.2854 17.9845 5.27542C16.8482 4.26543 15.4745 3.55976 13.9917 3.22426C12.5089 2.88875 10.9652 2.93434 9.50481 3.35677C8.04437 3.77921 6.71475 4.56471 5.64 5.64L1 10M23 14L18.36 18.36C17.2853 19.4353 15.9556 20.2208 14.4952 20.6432C13.0348 21.0657 11.4911 21.1112 10.0083 20.7757C8.52547 20.4402 7.1518 19.7346 6.01547 18.7246C4.87913 17.7146 4.01717 16.4332 3.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>\n          </svg>\n        </button>\n        <button class="hydrous-btn hydrous-close-btn" title="Cerrar chat">\n          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>\n          </svg>\n        </button>\n      </div>\n    `;return header}function setupEvents(chatButton,chatWindow,messagesContainer,inputContainer,config,state){const closeButton=chatWindow.querySelector(".hydrous-close-btn");const resetButton=chatWindow.querySelector(".hydrous-reset-btn");const textarea=inputContainer.querySelector(".hydrous-textarea");const sendButton=inputContainer.querySelector(".hydrous-send-btn");chatButton.addEventListener("click",(()=>{state.isOpen=true;chatButton.style.display="none";chatWindow.style.display="flex";if(!state.conversationId){startConversation(messagesContainer,config,state)}setTimeout((()=>textarea.focus()),300)}));closeButton.addEventListener("click",(()=>{state.isOpen=false;chatWindow.style.display="none";chatButton.style.display="flex"}));resetButton.addEventListener("click",(()=>{if(confirm("¿Estás seguro que deseas reiniciar la conversación? Se perderá todo el historial.")){resetConversation(messagesContainer,config,state)}}));textarea.addEventListener("input",(()=>{textarea.style.height="auto";textarea.style.height=Math.min(textarea.scrollHeight,120)+"px";if(textarea.value.trim()&&!state.isTyping){sendButton.classList.add("active");sendButton.disabled=false}else{sendButton.classList.remove("active");sendButton.disabled=true}}));const sendMessage=()=>{const message=textarea.value.trim();if(!message||state.isTyping)return;addUserMessage(messagesContainer,message,state);textarea.value="";textarea.style.height="auto";sendButton.classList.remove("active");sendButton.disabled=true;sendMessageToAPI(messagesContainer,message,config,state)};sendButton.addEventListener("click",sendMessage);textarea.addEventListener("keydown",(e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendMessage()}}))}async function startConversation(messagesContainer,config,state){try{state.isTyping=true;showTypingIndicator(messagesContainer);const response=await fetch(`${config.apiUrl}/chat/start`,{method:"POST",headers:{"Content-Type":"application/json"}});if(!response.ok){throw new Error(`Error: ${response.status}`)}const data=await response.json();state.conversationId=data.id;localStorage.setItem("hydrous_conversation_id",data.id);clearTypingIndicator(messagesContainer);const visibleMessages=data.messages.filter((msg=>msg.role!=="system")).forEach((msg=>{if(msg.role==="assistant"){addBotMessage(messagesContainer,msg.content,state)}}))}catch(err){console.error("Error al iniciar conversación:",err);clearTypingIndicator(messagesContainer);addBotMessage(messagesContainer,"Lo siento, ha ocurrido un error al iniciar el chat. Por favor, intenta nuevamente.",state)}finally{state.isTyping=false}}function resetConversation(messagesContainer,config,state){localStorage.removeItem("hydrous_conversation_id");state.conversationId=null;state.messages=[];messagesContainer.innerHTML=`\n      <div class="hydrous-message hydrous-message-bot">\n        <div class="hydrous-message-bubble">\n          Conversación reiniciada. Iniciando nuevo asistente...\n        </div>\n      </div>\n    `;showTypingIndicator(messagesContainer);setTimeout((()=>{startConversation(messagesContainer,config,state)}),1e3)}async function sendMessageToAPI(messagesContainer,message,config,state){try{state.isTyping=true;showTypingIndicator(messagesContainer);if(!state.conversationId){await startConversation(messagesContainer,config,state)}const response=await fetch(`${config.apiUrl}/chat/message`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({conversation_id:state.conversationId,message:message})});if(!response.ok){throw new Error(`Error: ${response.status}`)}const data=await response.json();clearTypingIndicator(messagesContainer);addBotMessage(messagesContainer,data.message,state)}catch(err){console.error("Error al enviar mensaje:",err);clearTypingIndicator(messagesContainer);addBotMessage(messagesContainer,"Lo siento, ha ocurrido un error al procesar tu mensaje. Por favor, intenta nuevamente.",state)}finally{state.isTyping=false}}function addUserMessage(messagesContainer,message,state){const emptyState=messagesContainer.querySelector(".hydrous-empty-state");if(emptyState){messagesContainer.removeChild(emptyState)}const messageEl=document.createElement("div");messageEl.className="hydrous-message hydrous-message-user";const time=(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:true});messageEl.innerHTML=`\n      <div class="hydrous-message-bubble">${escapeHtml(message)}</div>\n      <div class="hydrous-message-time">${time}</div>\n    `;messagesContainer.appendChild(messageEl);scrollToBottom(messagesContainer)}function addBotMessage(messagesContainer,message,state){const emptyState=messagesContainer.querySelector(".hydrous-empty-state");if(emptyState){messagesContainer.removeChild(emptyState)}const messageEl=document.createElement("div");messageEl.className="hydrous-message hydrous-message-bot";const time=(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:true});messageEl.innerHTML=`\n      <div class="hydrous-message-bubble">${escapeHtml(message)}</div>\n      <div class="hydrous-message-time">\n        <span class="hydrous-bot-indicator"></span>\n        ${time}\n      </div>\n    `;messagesContainer.appendChild(messageEl);scrollToBottom(messagesContainer)}function clearTypingIndicator(messagesContainer){const typingEl=messagesContainer.querySelector(".hydrous-typing");if(typingEl){messagesContainer.removeChild(typingEl)}}function scrollToBottom(messagesContainer){messagesContainer.scrollTop=messagesContainer.scrollHeight}function escapeHtml(unsafe){return unsafe.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/\n/g,"<br>")}})();