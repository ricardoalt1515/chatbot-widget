function setupEvents(e,o){const{chatButton:n,chatWindow:t,messagesContainer:i,inputContainer:s,textarea:a,sendButton:r,fileButton:c,fileInput:l,closeButton:d,resetButton:u}=uiElements;function v(){const e=a.value.trim().length>0,n=null!==o.selectedFile,t=(e||n)&&!o.isTyping;console.log("[Debug] Estado del botón:",{hasText:e,hasFile:n,canSend:t,isTyping:o.isTyping}),t?(r.classList.add("active"),r.disabled=!1):(r.classList.remove("active"),r.disabled=!0)}function g(){console.log("[Debug] Limpiando archivo"),o.selectedFile=null,l&&(l.value="");const e=s.querySelector(".hydrous-file-preview");e&&e.parentNode.removeChild(e);const n=s.querySelector(".hydrous-file-info");n&&(n.textContent=""),v()}async function h(){if(console.log("[Debug] Botón de envío clickeado"),r.disabled)return void console.log("[Debug] Botón deshabilitado, ignorando clic");const n=a.value.trim(),t=null!==o.selectedFile;if(console.log("[Debug] Estado al enviar:",{textoMensaje:n,tieneArchivo:t,estadoEscribiendo:o.isTyping}),n||t)try{if(r.disabled=!0,a.disabled=!0,c&&(c.disabled=!0),o.isTyping=!0,t){const e=s.querySelector(".hydrous-file-info");e&&(e.textContent="Enviando archivo...")}n?addUserMessage(i,n,o):t&&addUserMessage(i,"",o),t&&addFileToMessage(i,o.selectedFile),a.value="",a.style.height="48px",showTypingIndicator(i),o.conversationId&&o.conversationStarted||(console.log("[Debug] Iniciando conversación"),await async function(){try{console.log("[Debug] Solicitando ID de conversación");const n=await fetch(`${e.apiUrl}/chat/start`,{method:"POST",headers:{"Content-Type":"application/json"}});if(!n.ok)throw new Error(`Error al iniciar conversación: ${n.status}`);const t=await n.json();console.log("[Debug] Conversación iniciada:",t),o.conversationId=t.id,o.conversationStarted=!0,localStorage.setItem("hydrous_conversation_id",t.id)}catch(e){throw console.error("[Error] al iniciar conversación:",e),e}}()),t?(console.log("[Debug] Enviando archivo"),await async function(n){try{console.log("[Debug] Preparando FormData para archivo");const t=new FormData;t.append("conversation_id",o.conversationId),t.append("message",n||""),t.append("file",o.selectedFile),console.log(`[Debug] Enviando archivo: ${o.selectedFile.name}`);const s=await fetch(`${e.apiUrl}/documents/upload`,{method:"POST",body:t});if(!s.ok)throw new Error(`Error al subir archivo: ${s.status}`);const a=await s.json();console.log("[Debug] Respuesta del servidor:",a),clearTypingIndicator(i),addBotMessage(i,a.message||"Archivo recibido. Estamos procesando su contenido.",o),updateCachedMessages(o.conversationId,n,a.message||"Archivo recibido. Estamos procesando su contenido.")}catch(e){throw console.error("[Error] al enviar archivo:",e),e}}(n)):(console.log("[Debug] Enviando texto"),await async function(n){try{console.log("[Debug] Enviando mensaje de texto");const t=await fetch(`${e.apiUrl}/chat/message`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({conversation_id:o.conversationId,message:n})});if(!t.ok)throw new Error(`Error al enviar mensaje: ${t.status}`);const s=await t.json();console.log("[Debug] Respuesta del servidor:",s),clearTypingIndicator(i),addBotMessage(i,s.message,o),updateCachedMessages(o.conversationId,n,s.message)}catch(e){throw console.error("[Error] al enviar mensaje:",e),e}}(n)),console.log("[Debug] Mensaje enviado correctamente")}catch(e){console.error("[Error]",e),clearTypingIndicator(i),addBotMessage(i,"Lo siento, ocurrió un error. Por favor, intenta de nuevo.",o)}finally{r.disabled=!1,a.disabled=!1,c&&(c.disabled=!1),o.isTyping=!1,t&&g(),v(),a.focus()}else console.log("[Debug] No hay nada que enviar")}c&&l&&(c.addEventListener("click",(()=>{l.click()})),l.addEventListener("change",(()=>{if(l.files&&l.files[0]){const n=l.files[0];if(console.log("[Debug] Archivo seleccionado:",n.name,n.type,n.size),n.size>1024*e.maxFileSize*1024)return alert(`Error: El archivo excede el límite de ${e.maxFileSize}MB`),void(l.value="");o.selectedFile=n,function(e){const o=s.querySelector(".hydrous-file-preview");o&&o.parentNode.removeChild(o);const n=document.createElement("div");n.className="hydrous-file-preview";const t=getFileIcon(e.type),i=formatFileSize(e.size);n.innerHTML=`\n      <div class="hydrous-file-preview-icon">${t}</div>\n      <div class="hydrous-file-preview-name" title="${e.name}">${e.name} (${i})</div>\n      <button class="hydrous-file-preview-remove" title="Eliminar archivo">\n        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n        </svg>\n      </button>\n    `,s.querySelector(".hydrous-input-info").appendChild(n),n.querySelector(".hydrous-file-preview-remove").addEventListener("click",g);const a=s.querySelector(".hydrous-file-info");a&&(a.textContent="Archivo listo para enviar")}(n),v()}}))),window.HydrousWidget.clearFilePreview=g,r.addEventListener("click",h),a.addEventListener("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),r.disabled||h())})),a.addEventListener("input",(()=>{a.style.height="auto";const e=Math.min(a.scrollHeight,120);a.style.height=e+"px",v()})),n.addEventListener("click",(()=>{o.isOpen=!0,n.style.display="none",t.style.display="flex",i.querySelector(".hydrous-message")||startConversation(i,e,o),setTimeout((()=>a.focus()),300),trackEvent("chat_opened",e)})),d.addEventListener("click",(()=>{o.isOpen=!1,t.style.display="none",n.style.display="flex",trackEvent("chat_closed",e)})),u.addEventListener("click",(()=>{confirm("¿Estás seguro que deseas reiniciar la conversación? Se perderá todo el historial.")&&(resetConversation(i,e,o),v(),trackEvent("conversation_reset",e))})),v()}function formatFileSize(e){return e<1024?e+" B":e<1048576?(e/1024).toFixed(1)+" KB":(e/1048576).toFixed(1)+" MB"}